<!DOCTYPE html>
<html lang="zh-Hant" xmlns:th="http://www.thymeleaf.org">
<head>
<meta charset="UTF-8">
<title>é¤é»èœå–® | EatFast æ—©é¤åº—</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script src="https://cdn.tailwindcss.com"></script>

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link
	href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap"
	rel="stylesheet">

<link rel="stylesheet"
	href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.1/css/all.min.css">

<style>
.bg-milktea {
	background-color: #F7F2ED;
}

.bg-card {
	background-color: #fff8f2;
}

.text-milktea-dark {
	color: #A67B5B;
}

.border-milktea {
	border-color: #E5D0B6;
}

.btn-primary {
	background: #A67B5B;
	color: white;
}

.btn-primary:hover {
	background: #8B5A3C;
}

.btn-outline {
	border: 1.5px solid #A67B5B;
	color: #A67B5B;
}

.btn-outline:hover {
	background: #F3E5D6;
}

.active-category {
	background: #E5D0B6;
	color: #A67B5B;
	font-weight: bold;
}

:root {
    --bg-color: #FDFBF6;
    --container-bg: #FFFFFF;
    --primary-color: #A67B5B;
    --primary-hover: #8C684A;
    --text-color: #5D534A;
    --border-color: #DED0B6;
    --header-bg: #F5EFE6;
    --accent-color: #E1A87A;
    --shadow-light: rgba(0, 0, 0, 0.1);
    --shadow-medium: rgba(0, 0, 0, 0.15);
}

 body {
            font-family: 'Noto Sans TC', 'Microsoft JhengHei', Arial, sans-serif;
            line-height: 1.6;
            color: var(--text-color);
            background: linear-gradient(135deg, var(--bg-color) 0%, var(--header-bg) 100%);
            min-height: 100vh;
        }
        
/* Navigation Bar */
        .nav-fixed {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 60px; /* å›ºå®šå°èˆªæ¬„é«˜åº¦ */
            background: rgba(255, 255, 255, 0.95);
            padding: 0.5rem 0;
            box-shadow: 0 2px 10px var(--shadow-light);
            z-index: 1000;
            backdrop-filter: blur(10px);
        }

        .nav-container {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 2rem;
        }

        .nav-logo {
            display: flex;
            align-items: center;
            gap: 1rem;
            text-decoration: none;
            color: var(--primary-color);
        }

        .nav-logo-icon {
            width: 35px; /* èª¿æ•´ logo å¤§å° */
            height: 35px;
            object-fit: contain;
        }

       .nav-logo-text {
            font-size: 1.2rem; /* èª¿æ•´å°èˆªæ¬„æ–‡å­—å¤§å° */
            font-weight: 700;
        }



        .nav-menu {
            display: flex;
            gap: 2rem;
            align-items: center;
        }

        .nav-link {
            color: var(--text-color);
            text-decoration: none;
            font-weight: 500;
            transition: color 0.3s ease;
            position: relative;
        }

        .nav-link::after {
            content: '';
            position: absolute;
            bottom: -5px;
            left: 0;
            width: 0;
            height: 2px;
            background: var(--primary-color);
            transition: width 0.3s ease;
        }

        .nav-link:hover::after {
            width: 100%;
        }

        .nav-login {
            background: var(--primary-color);
            color: white;
            padding: 0.5rem 1.5rem;
            border-radius: 50px;
            text-decoration: none;
            transition: all 0.3s ease;
        }

        .nav-login:hover {
            background: var(--primary-hover);
            transform: translateY(-2px);
        }
		/* éŸ¿æ‡‰å¼è¨­è¨ˆ */
        @media (max-width: 768px) {
            .header {
                padding: 4rem 0 3rem;
            }
            
            .brand-title {
                font-size: 2.5rem;
            }
            
            .brand-subtitle {
                font-size: 1.2rem;
            }
            
            .nav-logo-text {
                font-size: 1rem;
            }
            
            .nav-fixed {
                height: 50px;
            }
            
            .nav-logo-icon {
                width: 30px;
                height: 30px;
            }
        }
        
        @media (max-width: 480px) {
            .main-content {
                padding: 2rem 1rem;
            }
            
            .header-content {
                padding: 0 1rem;
            }
            
            .feature-card {
                padding: 1.5rem;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .feature-actions {
                flex-direction: column;
            }
            
            .news-grid {
                grid-template-columns: 1fr;
            }
            .product-grid {
                grid-template-columns: 1fr;
            }
        }
        
        /* Footer å€åŸŸ */
        .footer {
            background: var(--primary-hover);
            color: white;
            text-align: center;
            padding: 2rem;
            margin-top: 4rem;
        }
        
        .footer-content {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .footer-links {
            display: flex;
            justify-content: center;
            gap: 2rem;
            margin-bottom: 1rem;
            flex-wrap: wrap;
        }
        
        .footer-link {
            color: white;
            text-decoration: none;
            font-weight: 500;
            transition: color 0.3s ease;
        }
        
        .footer-link:hover {
            color: var(--accent-color);
        }
        
        .copyright {
            opacity: 0.8;
            font-size: 0.9rem;
        }
/* ç™»å‡ºç¢ºèªæ¨¡æ…‹æ¡†æ¨£å¼ */
        .logout-modal {
    display: none;
    position: fixed;
    top: 0; left: 0; width: 100vw; height: 100vh;
    background: rgba(0,0,0,0.5);
    backdrop-filter: blur(5px);
    z-index: 10000;
    opacity: 0;
    transition: opacity 0.3s;
}
.logout-modal.show {
    display: flex;
    align-items: center;
    justify-content: center;
    opacity: 1;
}
.logout-modal-content {
    background: var(--container-bg);
    border-radius: 20px;
    padding: 2.5rem;
    max-width: 450px;
    width: 90%;
    text-align: center;
    box-shadow: 0 20px 60px rgba(0,0,0,0.3);
    transform: scale(0.7);
    transition: transform 0.3s;
    border: 1px solid var(--border-color);
}
.logout-modal.show .logout-modal-content {
    transform: scale(1);
}
.logout-modal-icon {
    width: 80px; height: 80px;
    background: linear-gradient(135deg, #ff6b6b, #ee5a24);
    border-radius: 50%;
    display: flex; align-items: center; justify-content: center;
    margin: 0 auto 1.5rem;
    color: white; font-size: 2.5rem;
    animation: pulse 2s infinite;
}
@keyframes pulse {
    0% {transform: scale(1); box-shadow: 0 0 0 0 rgba(255, 107, 107, 0.7);}
    70% {transform: scale(1.05); box-shadow: 0 0 0 10px rgba(255,107,107,0);}
    100% {transform: scale(1); box-shadow: 0 0 0 0 rgba(255,107,107,0);}
}
.logout-modal-title { font-size: 1.8rem; font-weight: 700; color: var(--primary-color); margin-bottom: 1rem; }
.logout-modal-message { font-size: 1.1rem; color: var(--text-color); margin-bottom: 2rem; line-height: 1.6; }
.logout-modal-actions { display: flex; gap: 1rem; justify-content: center; }
.logout-btn {
    padding: 0.8rem 2rem; border: none; border-radius: 50px;
    font-weight: 600; font-size: 1rem; cursor: pointer; transition: all 0.3s;
    display: flex; align-items: center; gap: 0.5rem; min-width: 120px; justify-content: center;
}
.logout-btn-confirm {
    background: linear-gradient(135deg, #dc3545, #c82333);
    color: white;
    box-shadow: 0 4px 15px rgba(220, 53, 69, 0.3);
}
.logout-btn-confirm:hover {
    background: linear-gradient(135deg, #c82333, #bd2130);
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(220, 53, 69, 0.4);
}
.logout-btn-cancel {
    background: var(--container-bg);
    color: var(--text-color);
    border: 2px solid var(--border-color);
}
.logout-btn-cancel:hover {
    background: var(--header-bg);
    border-color: var(--primary-color);
    color: var(--primary-color);
    transform: translateY(-2px);
}
.logout-loading {
    display: none;
    align-items: center;
    gap: 0.5rem;
    justify-content: center;
    margin-top: 1.5rem;
}
.logout-spinner {
    width: 20px; height: 20px;
    border: 2px solid rgba(255,255,255,0.3);
    border-radius: 50%;
    border-top-color: #c82333;
    animation: spin 1s ease-in-out infinite;
}
@keyframes spin { to { transform: rotate(360deg); } }

        /* éŸ¿æ‡‰å¼æ¨¡æ…‹æ¡† */
        @media (max-width: 480px) {
            .logout-modal-content {
                padding: 2rem;
                margin: 1rem;
            }

            .logout-modal-actions {
                flex-direction: column;
            }

            .logout-btn {
                width: 100%;
            }
        }
        
        /* å‹•ç•«æ•ˆæœ */
        .fade-in {
            animation: fadeIn 0.8s ease-in;
        }
        
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .slide-in {
            animation: slideIn 0.6s ease-out;
        }
        
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(-30px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

</style>
</head>
<body class="bg-milktea min-h-screen">
	<!-- æˆåŠŸåŠ å…¥è³¼ç‰©è»Šçš„æç¤ºå½ˆçª— -->
	<div id="toast-container"
		class="fixed inset-0 flex items-center justify-center z-[1001] pointer-events-none"></div>
	<!-- å‹•æ…‹è¨­å®šæ˜¯å¦ç™»å…¥ -->
	<script th:inline="javascript">
	    var isLoggedIn = /*[[${session.loggedInMemberId != null && session.isLoggedIn != null && session.isLoggedIn}]]*/ false;
	    var memberId = /*[[${session.loggedInMemberId}]]*/ null;
	    </script>

	<!-- Navbar -->
	<nav class="nav-fixed">
        <div class="nav-container">
            <a href="/welcome" class="nav-logo">
                <img src="images/123.png" alt="EatFast Logo" class="nav-logo-icon">
                <span class="nav-logo-text">EatFast æ—©é¤åº—</span>
            </a>
            
            <div class="nav-menu">
            	<a href="/news/list" class="nav-link">æœ€æ–°æ¶ˆæ¯</a>
            	<a href="/store/storelist" class="nav-link">é–€å¸‚æ“šé»</a>
                <a href="/menu" class="nav-link">é¤é»èœå–®</a>
                <!-- æ ¹æ“šç™»å…¥ç‹€æ…‹é¡¯ç¤ºä¸åŒå…§å®¹ -->
                <a th:if="${session.loggedInMemberId != null && session.isLoggedIn != null && session.isLoggedIn}" 
                   th:href="@{/member/dashboard}" class="nav-link">æœƒå“¡å°ˆå€</a>
                <a th:unless="${session.loggedInMemberId != null && session.isLoggedIn != null && session.isLoggedIn}" 
                   th:href="@{/api/v1/auth/member-login}" class="nav-link">æœƒå“¡å°ˆå€</a>
                <a href="/feedback/form" class="nav-link">è¯ç¹«æˆ‘å€‘</a>
                <a th:if="${session.loggedInMemberId != null && session.isLoggedIn != null && session.isLoggedIn}" 
                   th:href="@{/cart}" class="nav-link">è³¼ç‰©è»Š</a>
                <a th:unless="${session.loggedInMemberId != null && session.isLoggedIn != null && session.isLoggedIn}" 
                   th:href="@{/api/v1/auth/member-login}" class="nav-link">è³¼ç‰©è»Š</a>
			</div>

<!-- ç™»å…¥æŒ‰éˆ•æ ¹æ“šç™»å…¥ç‹€æ…‹è®ŠåŒ– -->
            <div th:if="${session.loggedInMemberId != null && session.isLoggedIn != null && session.isLoggedIn}" 
                 class="nav-user-info" style="display: flex; align-items: center; gap: 1rem;">
                <span style="color: var(--primary-color);">æ­¡è¿, <span th:text="${session.memberName}"></span></span>
                <button type="button" class="nav-login" style="background-color: #dc3545; border: none; cursor: pointer;" 
                        onclick="confirmLogout()">
                    <i class="fas fa-sign-out-alt"></i> ç™»å‡º
                </button>
                <!-- éš±è—çš„ç™»å‡ºè¡¨å–® -->
                <form id="logout-form" th:action="@{/api/v1/auth/logout}" method="post" style="display: none;">
                    <input type="hidden" name="_method" value="POST">
                </form>
            </div>
            <a th:unless="${session.loggedInMemberId != null && session.isLoggedIn != null && session.isLoggedIn}" 
               th:href="@{/api/v1/auth/member-login}" class="nav-login">
                <i class="fas fa-sign-in-alt"></i> æœƒå“¡ç™»å…¥
            </a>
        </div>

<!-- ç™»å‡º Modalï¼ˆæ–°ç‰ˆï¼‰ -->
<div class="logout-modal" id="logoutModal">
    <div class="logout-modal-content">
        <div class="logout-modal-icon">
            <i class="fas fa-sign-out-alt"></i>
        </div>
        <h3 class="logout-modal-title">ç™»å‡ºç¢ºèª</h3>
        <p class="logout-modal-message">æ‚¨ç¢ºå®šè¦ç™»å‡ºç³»çµ±å—ï¼Ÿ</p>
        <div class="logout-modal-actions">
            <button class="logout-btn logout-btn-confirm" onclick="logout()">ç¢ºå®šç™»å‡º</button>
            <button class="logout-btn logout-btn-cancel" onclick="closeLogoutModal()">å–æ¶ˆ</button>
        </div>
        <div class="logout-loading" id="logoutLoading" style="display:none;">
            <div class="logout-spinner"></div>
            <span>ç™»å‡ºä¸­...</span>
        </div>
    </div>
</div>
		</div>
	</nav>


	<!-- ä¸»å…§å®¹å€ -->
	<div class="max-w-7xl mx-auto py-8 flex flex-col md:flex-row gap-6 pt-24">

		<!-- å·¦å´åˆ†é¡å€ -->
		<aside
			class="w-1/5 min-w-[180px] bg-card rounded-2xl shadow-lg border border-milktea mr-8 p-6 h-fit">
			<!-- é–€å¸‚ä¸‹æ‹‰é¸å–® -->
			<div class="mb-6 flex flex-col justify-start gap-2">
				<label for="storeSelector"
					class="text-milktea-dark font-semibold">é¸æ“‡é–€å¸‚ï¼š</label> <select
					id="storeSelector" name="storeId" class="border rounded px-3 py-2 border-milktea focus:ring-milktea-dark focus:border-milktea-dark text-[#A67B5B] bg-white shadow-sm"
					onchange="handleStoreChange(this)">
					<option value="" disabled selected>è«‹é¸æ“‡é–€å¸‚</option>
					<option th:each="store : ${storeList}" th:value="${store.storeId}"
						th:text="${store.storeName}"
						th:selected="${store.storeId == session.selectedStoreId}">
					</option>
				</select>
			</div>
			<!-- é¤é»ç¨®é¡åˆ—è¡¨ -->
			<h2 class="text-lg font-bold text-milktea-dark mb-4">é¤é»ç¨®é¡</h2>
			<ul class="space-y-2">
				<li><a th:href="@{/menu}"
					th:classappend="${param.type} == null ? 'active-category' : ''"
					class="block rounded px-4 py-2 hover:bg-[#f4ede6] transition">
						å…¨éƒ¨ </a></li>
				<li th:each="type : ${mealTypeListData}"><a
					th:href="@{'/menu?type=' + ${type.mealTypeId}}"
					th:classappend="${param.type != null and !#strings.isEmpty(param.type[0]) and T(java.lang.Long).valueOf(param.type[0]).equals(type.mealTypeId) ? 'active-category' : ''}"
					th:text="${type.mealName}"
					class="block rounded px-4 py-2 hover:bg-[#f4ede6] transition">
						é¤é»ç¨®é¡åç¨± </a></li>
			</ul>
		</aside>



		<!-- å³å´é¤é»æ¸…å–® -->
		<main class="flex-1">
			<!-- æ¨™é¡Œ -->
			<div class="mb-8 text-center">
				<h1 class="text-4xl font-bold text-milktea-dark tracking-wider mb-2">ğŸ³
					æ—©é¤åº—èœå–®</h1>
				<p class="text-[#7a6451] text-base mb-2">ç¾åšæ—©é¤ï¼Œé¸ç”¨æ–°é®®é£Ÿæï¼Œæ¯ä¸€é“éƒ½å€¼å¾—æœŸå¾…ï¼</p>
				<span th:if="${currentMealTypeName != null}"
					th:text="'ç›®å‰åƒ…é¡¯ç¤ºï¼š' + ${currentMealTypeName}"
					class="inline-block px-3 py-1 bg-[#F0E6D3] rounded text-[#A67B5B] text-sm">
				</span>

			</div>
			<!-- é¤é»å¡ç‰‡å€ -->
			<div
				class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-8 pb-8">
				<div th:each="meal : ${mealListData}"
					class="bg-card rounded-2xl shadow-xl border border-milktea flex flex-col items-center p-6 hover:shadow-2xl transition-shadow duration-200 relative">
					<!-- åœ–ç‰‡å€ + æ¼‚æµ®è³¼ç‰©è»ŠæŒ‰éˆ• -->
					<div
						class="relative w-40 h-40 mb-4 flex justify-center items-center">
						<img th:src="${meal.mealPicUrl}" alt="é¤é»åœ–ç‰‡"
							class="w-40 h-40 object-cover rounded-xl border"
							onerror="this.onerror=null;this.src='/images/nopic.png';" />
					</div>
					<div class="w-full flex flex-col items-center">
						<h2 class="text-xl font-bold text-milktea-dark mb-1 text-center"
							th:text="${meal.mealName}"></h2>
						<div class="text-[#C7A083] text-lg font-semibold mb-2"
							th:text="'NT$ ' + ${meal.mealPrice}"></div>
					</div>

					<div class="flex items-center justify-center gap-2 mb-3">
					    <span class="star-display" data-meal-id="[[${meal.mealId}]]">
					      <span th:with="stars=${meal.avgStars}">
					        <th:block th:each="i : ${#numbers.sequence(1, 5)}">
					          <i th:if="${i <= T(java.lang.Math).floor(stars)}" class="fas fa-star text-yellow-400"></i>
					          <i th:if="${i == T(java.lang.Math).ceil(stars)} and ${stars > 0} and ${(stars - T(java.lang.Math).floor(stars)) >= 0.5}" class="fas fa-star-half-alt text-yellow-400"></i>
					          <i th:if="${(i > stars) and (i > T(java.lang.Math).ceil(stars) or (stars - T(java.lang.Math).floor(stars)) < 0.5)}" class="far fa-star text-[#DED0B6]"></i>
					        </th:block>
					        <span th:text="${stars} + ' / 5'" class="ml-1 text-sm text-[#A67B5B]"></span>
					      </span>
					    </span>
					</div>

					<div class="flex gap-2 w-full mt-auto">
						<!-- å·²æ”¶è—è¡¨å–® -->
						<form th:if="${meal.favored}" th:action="@{/member/removeFav}"
							method="post" class="flex-1">
							<input type="hidden" name="favMealId"
								th:value="${meal.favMealId}" /> <input type="hidden"
								name="redirectUrl"
								th:value="${param.type != null and !#strings.isEmpty(param.type[0]) ? '/menu?type=' + param.type[0] : '/menu'}" />
							<button type="submit"
								class="w-full rounded-lg px-3 py-2 text-sm text-center transition-all flex flex-col items-center justify-center btn-outline group"
								title="ç§»é™¤æ”¶è—">
								<i class="fas fa-heart" style="color: #d45a6b;"></i> <span
									class="ml-1 text-[#d45a6b] group-hover:text-[#b63a53]"></span>
							</button>
						</form>
						<!-- æœªæ”¶è—è¡¨å–® -->
						<form th:unless="${meal.favored}" th:action="@{/member/addFav}"
							method="post" class="flex-1" onsubmit="return checkLogin(event)">
							<input type="hidden" name="mealId" th:value="${meal.mealId}" />
							<input type="hidden" name="redirectUrl"
								th:value="${param.type != null and !#strings.isEmpty(param.type[0]) ? '/menu?type=' + param.type[0] : '/menu'}" />
							<button type="submit"
								class="w-full rounded-lg px-3 py-2 text-sm text-center transition-all flex flex-col items-center justify-center btn-outline group"
								title="åŠ å…¥æ”¶è—">
								<i class="far fa-heart group-hover:text-[#d45a6b]"
									style="color: #ccc;"></i> <span
									class="ml-1 text-[#A67B5B] group-hover:text-[#d45a6b]"></span>
							</button>
						</form>

						<!-- åŠ å…¥è³¼ç‰©è»Šï¼šé»æ“Šæœƒè·³modal -->
						<form th:action="@{/cart}" method="post" class="flex-1"
							onsubmit="return checkLogin(event)">
							<input type="hidden" name="mealId" th:value="${meal.mealId}" />
							<button type="button"
								class="w-full btn-outline rounded-lg px-3 py-2 text-sm text-center transition-all flex items-center justify-center gap-1"
								th:attr="data-mealid=${meal.mealId}"
								onclick="return handleAddToCartClick(this)">
								<i class="fas fa-shopping-cart"></i>
							</button>
						</form>
					</div>


				</div>
				<div th:if="${#lists.isEmpty(mealListData)}"
					class="col-span-full text-center text-milktea-dark py-10">
					æŸ¥ç„¡ç¬¦åˆçš„é¤é»ï¼</div>
			</div>
		</main>
	</div>

	<!-- è‡ªè¨‚è«‹å…ˆç™»å…¥ Modal -->
	<div id="loginModal"
		class="fixed inset-0 bg-black/30 flex items-center justify-center z-50 hidden">
		<div class="bg-white rounded-2xl p-8 shadow-2xl w-[320px] text-center">
			<div class="text-lg font-bold mb-3 text-[#A67B5B]">è«‹å…ˆç™»å…¥æœƒå“¡</div>
			<div class="text-[#554431] mb-6">æ‚¨å¿…é ˆå…ˆç™»å…¥æœƒå“¡æ‰èƒ½ä½¿ç”¨æ­¤åŠŸèƒ½ï¼Œæ˜¯å¦å‰å¾€ç™»å…¥é ï¼Ÿ</div>
			<div class="flex gap-4 justify-center">
				<button id="loginConfirmBtn"
					class="bg-[#A67B5B] hover:bg-[#8B5A3C] text-white rounded-full px-5 py-2 font-semibold shadow transition">å‰å¾€ç™»å…¥</button>
				<button id="loginCancelBtn"
					class="bg-[#F3E5D6] text-[#A67B5B] rounded-full px-5 py-2 font-semibold border border-[#E5D0B6] transition">å–æ¶ˆ</button>
			</div>
		</div>
	</div>

	<!-- ç™»å‡ºç¢ºèª Modal -->
	<div id="logoutModal"
		class="fixed inset-0 bg-black/30 flex items-center justify-center z-50 hidden">
		<div class="bg-white rounded-2xl p-8 shadow-2xl w-[320px] text-center">
			<div class="text-lg font-bold mb-3 text-[#A67B5B]">ç¢ºå®šè¦ç™»å‡ºå—ï¼Ÿ</div>
			<div class="text-[#554431] mb-6">ç™»å‡ºå¾Œå°‡è¿”å›é¦–é ã€‚</div>
			<div class="flex gap-4 justify-center">
				<button id="logoutConfirmBtn"
					class="bg-[#A67B5B] hover:bg-[#8B5A3C] text-white rounded-full px-5 py-2 font-semibold shadow transition">ç¢ºå®š</button>
				<button id="logoutCancelBtn"
					class="bg-[#F3E5D6] text-[#A67B5B] rounded-full px-5 py-2 font-semibold border border-[#E5D0B6] transition">å–æ¶ˆ</button>
			</div>
		</div>
	</div>

	<!-- ======= Modal å°è¦–çª— ======= -->
	<div id="mealDetailModal"
		class="fixed inset-0 bg-black/40 flex items-center justify-center z-50 hidden">
		<div
			class="bg-white rounded-2xl p-8 shadow-2xl w-full max-w-md relative">
			<!-- é—œé–‰æŒ‰éˆ• -->
			<button type="button" onclick="closeMealModal()"
				class="absolute top-2 right-2 text-[#A67B5B] text-xl">&times;</button>
			<!-- é¤é»åœ–ç‰‡ -->
			<div class="flex justify-center mb-4">
				<img id="modalMealPic" src="/images/nopic.png"
					class="w-40 h-40 object-cover rounded-xl border" />
			</div>
			<div class="text-2xl font-bold text-milktea-dark mb-2"
				id="modalMealName">é¤é»åç¨±</div>
			<div class="text-[#C7A083] text-lg font-semibold mb-2"
				id="modalMealPrice">NT$ 0</div>
			<div class="flex items-center gap-2 mb-3">
				<span id="modalMealStars" class="text-[#A67B5B] text-sm"></span>
			</div>
			<!-- æ•¸é‡é¸æ“‡ -->
			<div class="flex items-center gap-3 mb-5">
				<span>æ•¸é‡ï¼š</span>
				<button type="button" onclick="changeQty(-1)"
					class="w-8 h-8 rounded bg-[#E5D0B6]">-</button>
				<input id="modalMealQty" type="number" min="1" value="1"
					class="w-12 text-center border rounded" readonly />
				<button type="button" onclick="changeQty(1)"
					class="w-8 h-8 rounded bg-[#E5D0B6]">+</button>
			</div>
			<form method="post" th:action="@{/cart/add}" id="modalCartForm">
				<input type="hidden" name="mealId" id="modalMealId" /> 
				<input
					type="hidden" name="quantity" id="modalMealFormQty" value="1" /> 
				<input
					type="hidden" name="storeId" id="modalStoreId" />
				<button type="submit"
					class="w-full btn-primary rounded-lg px-4 py-2 mt-2">
					<i class="fas fa-shopping-cart"></i> åŠ å…¥è³¼ç‰©è»Š
				</button>
			</form>
		</div>
	</div>

	<script th:inline="javascript">
	  // å°‡ mealListData è½‰æˆ JS é™£åˆ—ï¼ˆåƒ…éœ€ç”¨åˆ°çš„å±¬æ€§ï¼‰
	  const mealData = /*[[${mealListData}]]*/ [];
	</script>

	<script>
  // å…¨åŸŸå‡½å¼ï¼šé¸æ“‡é–€å¸‚å¾Œå­˜å…¥ sessionStorage ä¸¦é‡æ–°è¼‰å…¥é é¢
async function handleStoreChange(selectEl) {
    const newStoreId = selectEl.value;
    if (!newStoreId) return;

    // å…ˆå¾å¾Œç«¯ç²å–æœ€æº–ç¢ºçš„è³¼ç‰©è»Šå•†å“æ•¸é‡
    let itemCount = 0;
    try {
        const response = await fetch('/api/cart/count');
        if (response.ok) {
            const data = await response.json();
            itemCount = data.item_count;
        }
    } catch (error) {
        console.error("æŸ¥è©¢è³¼ç‰©è»Šæ•¸é‡å¤±æ•—:", error);
        // å¦‚æœæŸ¥è©¢å¤±æ•—ï¼Œç‚ºå®‰å…¨èµ·è¦‹ï¼Œç›´æ¥è·³è½‰ï¼Œä¸æç¤º
        window.location.href = `/menu?storeId=${newStoreId}`;
        return;
    }
    
    const currentCartStoreId = sessionStorage.getItem("cartStoreId");

    // ã€æ ¸å¿ƒä¿®æ­£ã€‘ç¾åœ¨çš„åˆ¤æ–·ä¾æ“šæ˜¯çœŸå¯¦çš„å•†å“æ•¸é‡ itemCount
    if (itemCount > 0 && currentCartStoreId && currentCartStoreId !== newStoreId) {
        if (confirm("æ‚¨çš„è³¼ç‰©è»Šå…§å°šæœ‰å•†å“ï¼Œæ›´æ›é–€å¸‚å°‡æœƒæ¸…ç©ºè³¼ç‰©è»Šï¼Œç¢ºå®šè¦ç¹¼çºŒå—ï¼Ÿ")) {
            // ä½¿ç”¨è€…åŒæ„ï¼Œå‘¼å«å¾Œç«¯ API æ¸…ç©ºè³¼ç‰©è»Š
            clearCartForStoreChange(newStoreId);
        } else {
            // ä½¿ç”¨è€…å–æ¶ˆï¼Œå°‡ä¸‹æ‹‰é¸å–®æ¢å¾©åŸç‹€
            selectEl.value = currentCartStoreId;
            return;
        }
    } else {
        // å¦‚æœè³¼ç‰©è»Šæ˜¯ç©ºçš„ï¼Œæˆ–é¸æ“‡çš„é–€å¸‚èˆ‡åŸä¾†ç›¸åŒï¼Œç›´æ¥å°å‘æ–°é é¢
        window.location.href = `/menu?storeId=${newStoreId}`;
    }
}

// ã€æ–°å¢ã€‘ä¸€å€‹å°ˆé–€ç”¨æ–¼æ¸…ç©ºè³¼ç‰©è»Šä¸¦è™•ç†å¾ŒçºŒå‹•ä½œçš„å‡½å¼
async function clearCartForStoreChange(newStoreId) {
    if (!memberId) {
        alert("è«‹å…ˆç™»å…¥æœƒå“¡");
        return;
    }
    // å‘¼å«å¾Œç«¯æ¸…ç©ºè³¼ç‰©è»Šçš„ API (DELETE /cart/member/{id})
    try {
        const response = await fetch(`/cart/member/${memberId}`, { method: 'DELETE' });
        if (!response.ok) throw new Error('æ¸…ç©ºè³¼ç‰©è»Šå¤±æ•—');

      	//ç›´æ¥å°å‘å¸¶æœ‰ storeId åƒæ•¸çš„æ–° URL
        window.location.href = `/menu?storeId=${newStoreId}`;
        
    } catch(error) {
        alert("æ¸…ç©ºè³¼ç‰©è»Šæ™‚ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚");
    }
}

  // é¡¯ç¤ºè«‹å…ˆç™»å…¥çš„å½ˆçª—
  function checkLogin(e) {
      if (!isLoggedIn) {
          if (e) e.preventDefault();
          showLoginModal();
          return false;
      }
      return true;
  }

  function handleAddToCartClick(btnElement) {
      if (!checkLogin()) {
          return false;
      }
      openMealModal(btnElement);
      return false;
  }

  function showLoginModal() {
      document.getElementById('loginModal').classList.remove('hidden');
  }
  function hideLoginModal() {
      document.getElementById('loginModal').classList.add('hidden');
  }

  function showLogoutModal() {
      document.getElementById('logoutModal').classList.remove('hidden');
  }
  function hideLogoutModal() {
      document.getElementById('logoutModal').classList.add('hidden');
  }

  let currentMeal = null;

  function openMealModal(btn) {
	    // ã€é—œéµæ–°å¢ã€‘ç¬¬ä¸€æ­¥ï¼šå…ˆæª¢æŸ¥æ˜¯å¦å·²é¸æ“‡é–€å¸‚
	    const storeId = sessionStorage.getItem("selectedStoreId");
	    if (!storeId) {
	        // å¦‚æœæ²’æœ‰é¸æ“‡é–€å¸‚ï¼Œè·³å‡ºæç¤ºï¼Œä¸¦çµ‚æ­¢å¾ŒçºŒæ“ä½œ
	        alert("è«‹å…ˆå¾é é¢ä¸Šæ–¹çš„ä¸‹æ‹‰é¸å–®ä¸­é¸æ“‡ä¸€å€‹å–é¤é–€å¸‚ï¼");
	        return; // ç›´æ¥çµæŸå‡½å¼
	    }

	    const mealId = Number(btn.getAttribute('data-mealid'));
	    currentMeal = mealData.find(m => m.mealId === mealId);
	    if (!currentMeal) return;

	    document.getElementById('modalMealId').value = currentMeal.mealId;
	    document.getElementById('modalMealPic').src = currentMeal.mealPicUrl;
	    document.getElementById('modalMealName').textContent = currentMeal.mealName;
	    document.getElementById('modalMealPrice').textContent = 'NT$ ' + currentMeal.mealPrice;
	    document.getElementById('modalMealStars').innerHTML = renderStars(currentMeal.avgStars ?? 0);
	    document.getElementById('modalMealQty').value = 1;
	    document.getElementById('modalMealFormQty').value = 1;

	    // å°‡å·²ç¢ºèªå­˜åœ¨çš„ storeId å¡«å…¥è¡¨å–®
	    document.getElementById('modalStoreId').value = storeId;

	    document.getElementById('mealDetailModal').classList.remove('hidden');
	}

  function closeMealModal() {
      document.getElementById('mealDetailModal').classList.add('hidden');
  }

  function changeQty(delta) {
      let input = document.getElementById('modalMealQty');
      let val = parseInt(input.value) + delta;
      if (val < 1) val = 1;
      input.value = val;
      document.getElementById('modalMealFormQty').value = val;
  }

  function renderStars(score, max=5) {
	  if (score == null || isNaN(score)) score = 0; // é è¨­ 0 åˆ†
	  let html = '';
	  for(let i = 1; i <= max; i++) {
	    if (score >= i) { // å…¨æ˜Ÿ
	      html += '<i class="fas fa-star text-yellow-400"></i>';
	    } else if (score > i-1 && score < i) { // åŠæ˜Ÿ
	      html += '<i class="fas fa-star-half-alt text-yellow-400"></i>';
	    } else { // ç©ºæ˜Ÿ
	      html += '<i class="far fa-star text-[#DED0B6]"></i>';
	    }
	  }
	  if (score === 0) {
		    html += ` <span class="ml-1 text-sm text-[#9D7C64]">å°šç„¡è©•åˆ†</span>`;
		  } else {
		    html += ` <span class="ml-1 text-sm text-[#9D7C64]">${score.toFixed(1)} / 5</span>`;
		  }
	  return html;
	}
  
	//âœ… æ–°å¢ï¼šé¡¯ç¤ºæç¤ºè¨Šæ¯çš„å‡½å¼ (ç½®ä¸­ + å¯é çš„è‡ªå‹•é—œé–‰)
    function showToast(message, isSuccess = true) {
        const container = document.getElementById('toast-container');
        if (!container) return;

        // ç‚ºäº†ç¢ºä¿ç•«é¢ä¸­å¤®æ°¸é åªæœ‰ä¸€å€‹æç¤ºï¼Œå…ˆæ¸…ç©ºå®¹å™¨
        container.innerHTML = '';

        // å»ºç«‹ toast å…ƒç´ 
        const toast = document.createElement('div');
        const bgColor = isSuccess ? 'bg-[#A67B5B]' : 'bg-red-500';
        const icon = isSuccess ? '<i class="fas fa-check-circle mr-3"></i>' : '<i class="fas fa-times-circle mr-3"></i>';

        // ä½¿ç”¨ç¸®æ”¾èˆ‡é€æ˜åº¦å‹•ç•«ï¼Œä¸¦é‡æ–°å•Ÿç”¨æ»‘é¼ äº‹ä»¶
        toast.className = `pointer-events-auto flex items-center text-white text-lg font-semibold px-6 py-4 rounded-xl shadow-2xl transform transition-all duration-300 opacity-0 scale-90`;
        toast.classList.add(bgColor);
        toast.innerHTML = `${icon} ${message}`;

        container.appendChild(toast);

        // --- è§¸ç™¼ã€Œå‡ºç¾ã€å‹•ç•« ---
        // ä½¿ç”¨ä¸€å€‹æ¥µçŸ­çš„å»¶é²ï¼Œç¢ºä¿ç€è¦½å™¨èƒ½æ•æ‰åˆ° class çš„è®ŠåŒ–ä¸¦è§¸ç™¼ transition
        setTimeout(() => {
            toast.classList.remove('opacity-0', 'scale-90');
            toast.classList.add('opacity-100', 'scale-100');
        }, 10);

        // --- è§¸ç™¼ã€Œæ¶ˆå¤±ã€å‹•ç•« ---
        // è¨­å®š 2.5 ç§’å¾Œé–‹å§‹æ¶ˆå¤±
        setTimeout(() => {
            toast.classList.remove('opacity-100', 'scale-100');
            toast.classList.add('opacity-0', 'scale-90');

            // ã€é—œéµä¿®å¾©ã€‘åœ¨æ·¡å‡ºå‹•ç•«ï¼ˆ300msï¼‰çµæŸå¾Œï¼Œç›´æ¥å¾ DOM ä¸­ç§»é™¤å…ƒç´ 
            // é€™æ¨£å°±ä¸å†ä¾è³´å¯èƒ½ä¸è§¸ç™¼çš„ 'transitionend' äº‹ä»¶
            setTimeout(() => {
                if (container.contains(toast)) {
                    container.removeChild(toast);
                }
            }, 300); // é€™å€‹æ™‚é–“è¦å’Œ CSS çš„ duration-300 åŒ¹é…

        }, 1200); // æç¤ºé¡¯ç¤º 2.5 ç§’
    }

    // âœ… æ›´æ–°é¤é»æ˜Ÿæ˜Ÿé¡¯ç¤º
  function updateMealStars() {
      fetch('/api/meals/ratings')
          .then(res => res.json())
          .then(data => {
              data.forEach(meal => {
                  document.querySelectorAll(`.star-display[data-meal-id='${meal.mealId}']`).forEach(el => {
                      el.innerHTML = renderStars(meal.avgStars);
                  });
              });
          });
  }

  // âœ… æ•´åˆæ‰€æœ‰ DOMContentLoaded é‚è¼¯
  document.addEventListener('DOMContentLoaded', function () {
	  
	//å„ªå…ˆå¾ URL åŒæ­¥ storeId åˆ° sessionStorage
      const urlParams = new URLSearchParams(window.location.search);
      const storeIdFromUrl = urlParams.get('storeId');

      if (storeIdFromUrl) {
          // å¦‚æœ URL ä¸­æœ‰ storeIdï¼Œå°‡å®ƒè¨­å®šç‚º sessionStorage çš„å€¼ï¼Œç¢ºä¿å®ƒæ˜¯æœ€æ–°çš„
          sessionStorage.setItem("selectedStoreId", storeIdFromUrl);
          sessionStorage.setItem("cartStoreId", storeIdFromUrl); // åŒæ™‚ä¹Ÿæ›´æ–°è³¼ç‰©è»Šé–€å¸‚ID
      }
	  
      // 1. å¥—ç”¨ sessionStorage ä¸­çš„ storeId
      const selectedStoreId = sessionStorage.getItem("selectedStoreId");
      if (selectedStoreId) {
          const selector = document.getElementById('storeSelector');
          if (selector) selector.value = selectedStoreId;
      }

      // 2. ç™»å…¥ modal æŒ‰éˆ•
      document.getElementById('loginConfirmBtn').onclick = () => {
          window.location.href = '/api/v1/auth/member-login';
      };
      document.getElementById('loginCancelBtn').onclick = hideLoginModal;

      // 3. ç™»å‡º modal è¡Œç‚º
      const logoutBtn = document.getElementById('logoutBtn');
      const logoutForm = document.getElementById('logoutForm');
      const logoutConfirmBtn = document.getElementById('logoutConfirmBtn');
      const logoutCancelBtn = document.getElementById('logoutCancelBtn');

      if (logoutBtn) {
          logoutBtn.onclick = function (e) {
              e.preventDefault();
              showLogoutModal();
          };
      }

      if (logoutCancelBtn) {
          logoutCancelBtn.onclick = hideLogoutModal;
      }

      if (logoutConfirmBtn && logoutForm) {
          logoutConfirmBtn.onclick = function () {
              hideLogoutModal();
              fetch(logoutForm.action, {
                  method: 'POST',
                  credentials: 'same-origin'
              }).then(res => {
                  if (res.ok) {
                      window.location.href = '/welcome';
                  } else {
                      alert('ç™»å‡ºå¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ï¼');
                  }
              }).catch(error => {
                  console.error('ç™»å‡ºè«‹æ±‚ç™¼ç”ŸéŒ¯èª¤:', error);
                  alert('ç™»å‡ºå¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯é€£ç·šæˆ–ç¨å¾Œå†è©¦ï¼');
              });
          };
      }

      // 4. é»æ“Š modal èƒŒæ™¯å¯é—œé–‰
      const loginModal = document.getElementById('loginModal');
      const logoutModal = document.getElementById('logoutModal');
      const mealDetailModal = document.getElementById('mealDetailModal');

      if (loginModal) {
          loginModal.addEventListener('click', function (e) {
              if (e.target === loginModal) hideLoginModal();
          });
      }

      if (logoutModal) {
          logoutModal.addEventListener('click', function (e) {
              if (e.target === logoutModal) hideLogoutModal();
          });
      }

      if (mealDetailModal) {
          mealDetailModal.addEventListener('click', function (e) {
              if (e.target === mealDetailModal) closeMealModal();
          });
      }

      // 5. åˆå§‹æ˜Ÿæ˜Ÿé¡¯ç¤ºèˆ‡å®šæ™‚åˆ·æ–°
      updateMealStars();
      setInterval(updateMealStars, 30000);
   // âœ… æ–°å¢ï¼šæ””æˆªä¸¦ä¿®æ”¹ Modal ä¸­çš„è³¼ç‰©è»Šè¡¨å–®æäº¤è¡Œç‚º
      const modalCartForm = document.getElementById('modalCartForm');
      if (modalCartForm) {
          modalCartForm.addEventListener('submit', function (e) {
              // 1. é˜»æ­¢è¡¨å–®çš„é è¨­æäº¤è¡Œç‚º (é¿å…é é¢åˆ·æ–°)
              e.preventDefault();

              // 2. ç²å–è¡¨å–®è³‡æ–™
              const formData = new FormData(modalCartForm);
              const data = new URLSearchParams(formData);
              
           // ã€æ–°å¢ã€‘ç•¶æˆåŠŸåŠ å…¥ç¬¬ä¸€å€‹å•†å“æ™‚ï¼Œå°‡é–€å¸‚IDè¨˜éŒ„åˆ° sessionStorage
              const currentCartStoreId = sessionStorage.getItem("cartStoreId");
              if (!currentCartStoreId) {
                   sessionStorage.setItem("cartStoreId", formData.get("storeId"));
              }
              // 3. ä½¿ç”¨ Fetch API å°‡è³‡æ–™é€åˆ°å¾Œç«¯
              fetch(modalCartForm.action, {
                  method: 'POST',
                  headers: {
                      'Content-Type': 'application/x-www-form-urlencoded',
                  },
                  body: data
              })
              .then(response => {
                  // 4. æ ¹æ“šä¼ºæœå™¨å›æ‡‰åˆ¤æ–·æ˜¯å¦æˆåŠŸ
                  if (response.ok) {
                      // æˆåŠŸåŠ å…¥è³¼ç‰©è»Š
                      closeMealModal(); // é—œé–‰ Modal
                      showToast('âœ… å·²æˆåŠŸåŠ å…¥è³¼ç‰©è»Šï¼'); // é¡¯ç¤ºæˆåŠŸæç¤º
                  } else {
                      // è™•ç†å¤±æ•—æƒ…æ³
                      response.text().then(text => {
                           // å¦‚æœå¾Œç«¯æœ‰å›å‚³éŒ¯èª¤è¨Šæ¯ï¼Œå¯ä»¥é¡¯ç¤ºå®ƒ
                           showToast(`åŠ å…¥å¤±æ•—: ${text || 'è«‹ç¨å¾Œå†è©¦'}`, false);
                      });
                  }
              })
              .catch(error => {
                  // 5. è™•ç†ç¶²è·¯éŒ¯èª¤
                  console.error('åŠ å…¥è³¼ç‰©è»Šè«‹æ±‚å¤±æ•—:', error);
                  showToast('ç¶²è·¯éŒ¯èª¤ï¼Œè«‹æª¢æŸ¥é€£ç·šã€‚', false);
              });
          });
      }
  });
      
</script>
<script>
// ç™»å‡º Modal æ§åˆ¶
function confirmLogout() {
    document.getElementById('logoutModal').classList.add('show');
}
function closeLogoutModal() {
    document.getElementById('logoutModal').classList.remove('show');
}
function logout() {
    document.getElementById('logoutLoading').style.display = 'flex';
    // fetch ç™»å‡º
    fetch('/api/v1/auth/logout', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-Requested-With': 'XMLHttpRequest'
        },
        credentials: 'same-origin'
    })
    .then(response => {
        if (response.ok) {
            window.location.reload();
        } else {
            alert('ç™»å‡ºå¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦');
            closeLogoutModal();
            document.getElementById('logoutLoading').style.display = 'none';
        }
    })
    .catch(error => {
        alert('ç™»å‡ºå¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦');
        closeLogoutModal();
        document.getElementById('logoutLoading').style.display = 'none';
    });
}

// é»æ“Š modal èƒŒæ™¯è‡ªå‹•é—œé–‰
document.addEventListener('DOMContentLoaded', function() {
    const logoutModal = document.getElementById('logoutModal');
    if (logoutModal) {
        logoutModal.addEventListener('click', function(e) {
            if (e.target === logoutModal) closeLogoutModal();
        });
    }
});
</script>



	<footer class="footer">
            <div class="copyright">
                Â© 2025 EatFast æ—©é¤åº— - ç‰ˆæ¬Šæ‰€æœ‰ | ç‚ºæ‚¨æä¾›æœ€å„ªè³ªçš„æ—©é¤æœå‹™
            </div>
    </footer>


</body>
</html>