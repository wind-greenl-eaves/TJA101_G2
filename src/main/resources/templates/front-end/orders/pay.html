<!DOCTYPE html>
<html lang="zh-TW" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>è¨‚å–®ä»˜æ¬¾</title>
    <style>
        body { 
            font-family: 'Helvetica Neue', Arial, sans-serif; 
            background-color: #f4f4f4; 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            min-height: 100vh; 
            margin: 0; 
            padding: 20px;
            box-sizing: border-box;
        }
        .checkout-container { 
            background-color: #fff; 
            padding: 30px; 
            border-radius: 8px; 
            box-shadow: 0 4px 12px rgba(0,0,0,0.1); 
            width: 100%; 
            max-width: 480px; 
            border-top: 4px solid #f0ad4e; 
        }
        .section { 
            border-top: 1px solid #eee; 
            padding-top: 20px; 
            margin-top: 20px; 
        }
        .order-details div { 
            display: flex; 
            justify-content: space-between; 
            margin-bottom: 10px; 
            color: #555; 
        }
        .order-details span:first-child { 
            color: #333; 
            font-weight: 500; 
        }
        .form-label { 
            margin-bottom: 8px; 
            font-weight: 500; 
            color: #333;
            display: block;
        }
        .form-group { 
            margin-bottom: 15px; 
        }
        input[type="text"], input[type="tel"], select { 
            width: 100%; 
            padding: 12px; 
            border: 1px solid #ccc; 
            border-radius: 4px; 
            box-sizing: border-box; 
            font-size: 16px;
            transition: border-color 0.3s ease;
        }
        input[type="text"]:focus, input[type="tel"]:focus, select:focus {
            outline: none;
            border-color: #f0ad4e;
            box-shadow: 0 0 0 2px rgba(240, 173, 78, 0.2);
        }
        .card-number-group { 
            display: flex; 
            gap: 10px; 
        }
        .card-number-input {
            flex: 1;
            text-align: center;
            font-family: 'Courier New', monospace;
            font-size: 18px;
            letter-spacing: 2px;
        }
        .expiry-cvv-group { 
            display: flex; 
            gap: 15px; 
        }
        .expiry-group {
            flex: 1;
            display: flex;
            gap: 10px;
        }
        .cvv-group {
            flex: 1;
        }
        .year-month-input {
            flex: 1;
            text-align: center;
        }
        .cvv-input {
            text-align: center;
            font-family: 'Courier New', monospace;
            font-size: 16px;
            letter-spacing: 1px;
        }
        .confirm-button { 
            width: 100%; 
            padding: 15px; 
            background-color: #f0ad4e; 
            border: none; 
            color: white; 
            font-size: 1.2em; 
            font-weight: bold; 
            border-radius: 4px; 
            cursor: pointer; 
            margin-top: 20px; 
            transition: background-color 0.3s ease;
        }
        .confirm-button:hover {
            background-color: #ec971f;
        }
        .confirm-button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }
        .card-type-indicator {
            display: inline-block;
            margin-left: 10px;
            font-size: 14px;
            color: #666;
        }
        .input-error {
            border-color: #d9534f !important;
            box-shadow: 0 0 0 2px rgba(217, 83, 79, 0.2) !important;
        }
        .error-message {
            color: #d9534f;
            font-size: 12px;
            margin-top: 5px;
            display: none;
        }
        .security-info {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .security-icon {
            width: 16px;
            height: 16px;
            background-color: #5cb85c;
            border-radius: 50%;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 10px;
        }
        .order-title {
            font-size: 1.8em;
            color: #333;
            margin-bottom: 20px;
            text-align: center;
        }
    </style>
</head>
<body>

<div class="checkout-container">
    <h2 class="order-title">è¨‚å–®ä»˜æ¬¾</h2>
    
    <div class="order-details" th:object="${orderToPay}">
        <div>
            <span>å–é¤é–€å¸‚</span>
            <span th:text="*{storeName}"></span>
        </div>
        <div>
            <span>è¨‚å–®ç·¨è™Ÿ</span>
            <span th:text="*{orderListId}"></span>
        </div>
        <div>
            <span>è¨‚å–®æ™‚é–“</span>
            <span th:text="${#temporals.format(orderToPay.orderDate, 'yyyy-MM-dd HH:mm')}"></span>
        </div>
        <div>
            <span>å–é¤æ™‚é–“</span>
            <span th:text="${orderToPay.pickupTime != null ? orderToPay.pickupTime : 'æœªè¨­å®š'}"></span>
        </div>
        <div>
            <span>ç¸½é‡‘é¡</span>
            <span th:text="'NT$ ' + ${orderToPay.totalAmount}"></span>
        </div>
    </div>

    <form class="section" th:action="@{/orders/process-payment}" method="post" id="paymentForm">
        <h4>ä¿¡ç”¨å¡è³‡æ–™ (Credit Card Information)</h4>
        <input type="hidden" name="orderId" th:value="${orderToPay.orderListId}" />

        <!-- ä¿¡ç”¨å¡è™Ÿç¢¼ -->
        <div class="form-group">
            <label class="form-label">ä¿¡ç”¨å¡è™Ÿç¢¼ <span class="card-type-indicator" id="cardType"></span></label>
            <div class="card-number-group">
                <input type="tel" id="cardNumber1" name="cardNumber1" maxlength="4" placeholder="1234" class="card-number-input" required>
                <input type="tel" id="cardNumber2" name="cardNumber2" maxlength="4" placeholder="5678" class="card-number-input" required>
                <input type="tel" id="cardNumber3" name="cardNumber3" maxlength="4" placeholder="9012" class="card-number-input" required>
                <input type="tel" id="cardNumber4" name="cardNumber4" maxlength="4" placeholder="3456" class="card-number-input" required>
            </div>
            <div class="error-message" id="cardNumberError">è«‹è¼¸å…¥æœ‰æ•ˆçš„ä¿¡ç”¨å¡è™Ÿç¢¼</div>
            <div class="security-info">
                <span class="security-icon">ğŸ”’</span>
                æ‚¨çš„ä¿¡ç”¨å¡è³‡è¨Šæ¡ç”¨SSLåŠ å¯†ä¿è­·
            </div>
        </div>
        
        <!-- æœ‰æ•ˆæœŸé™å’Œå®‰å…¨ç¢¼ -->
        <div class="form-group">
            <div class="expiry-cvv-group">
                <div class="expiry-group">
                    <div>
                        <label class="form-label">æœ‰æ•ˆæœŸé™</label>
                        <div style="display: flex; gap: 10px;">
                            <select id="expiryMonth" name="expiryMonth" class="year-month-input" required>
                                <option value="">æœˆ</option>
                                <option value="01">01</option>
                                <option value="02">02</option>
                                <option value="03">03</option>
                                <option value="04">04</option>
                                <option value="05">05</option>
                                <option value="06">06</option>
                                <option value="07">07</option>
                                <option value="08">08</option>
                                <option value="09">09</option>
                                <option value="10">10</option>
                                <option value="11">11</option>
                                <option value="12">12</option>
                            </select>
                            <select id="expiryYear" name="expiryYear" class="year-month-input" required>
                                <option value="">å¹´</option>
                                <!-- å¹´ä»½é¸é …å°‡ç”±JavaScriptå‹•æ…‹ç”Ÿæˆ -->
                            </select>
                        </div>
                    </div>
                </div>
                <div class="cvv-group">
                    <label class="form-label">å®‰å…¨ç¢¼ (CVV)</label>
                    <input type="tel" id="cvv" name="cvv" maxlength="3" placeholder="123" class="cvv-input" required>
                    <div class="security-info">
                        <span style="font-size: 10px;">å¡ç‰‡èƒŒé¢3ä½æ•¸å­—</span>
                    </div>
                </div>
            </div>
            <div class="error-message" id="expiryError">è«‹é¸æ“‡æœ‰æ•ˆçš„åˆ°æœŸæ—¥</div>
            <div class="error-message" id="cvvError">è«‹è¼¸å…¥3ä½å®‰å…¨ç¢¼</div>
        </div>

        <button type="submit" class="confirm-button" id="payButton">ç¢ºèªä»˜æ¬¾</button>
    </form>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // ç”Ÿæˆå¹´ä»½é¸é …
    const currentYear = new Date().getFullYear();
    const expiryYearSelect = document.getElementById('expiryYear');
    for (let i = 0; i < 15; i++) {
        const year = currentYear + i;
        const option = document.createElement('option');
        option.value = year;
        option.textContent = year.toString().slice(-2); // åªé¡¯ç¤ºæœ«å…©ä½æ•¸
        expiryYearSelect.appendChild(option);
    }

    // ä¿¡ç”¨å¡è™Ÿç¢¼è‡ªå‹•è·³è½‰
    const cardInputs = ['cardNumber1', 'cardNumber2', 'cardNumber3', 'cardNumber4'];
    cardInputs.forEach((id, index) => {
        const input = document.getElementById(id);
        
        input.addEventListener('input', function(e) {
            // åªå…è¨±æ•¸å­—
            this.value = this.value.replace(/\D/g, '');
            
            // è‡ªå‹•è·³è½‰åˆ°ä¸‹ä¸€å€‹è¼¸å…¥æ¡†
            if (this.value.length === 4 && index < cardInputs.length - 1) {
                document.getElementById(cardInputs[index + 1]).focus();
            }
            
            // æª¢æ¸¬ä¿¡ç”¨å¡é¡å‹
            if (index === 0) {
                detectCardType(this.value);
            }
        });

        // è™•ç†é€€æ ¼éµ
        input.addEventListener('keydown', function(e) {
            if (e.key === 'Backspace' && this.value.length === 0 && index > 0) {
                document.getElementById(cardInputs[index - 1]).focus();
            }
        });
    });

    // CVVåªå…è¨±æ•¸å­—
    document.getElementById('cvv').addEventListener('input', function(e) {
        this.value = this.value.replace(/\D/g, '');
    });

    // ä¿¡ç”¨å¡é¡å‹æª¢æ¸¬
    function detectCardType(firstFour) {
        const cardTypeIndicator = document.getElementById('cardType');
        
        if (firstFour.startsWith('4')) {
            cardTypeIndicator.textContent = '(VISA)';
        } else if (firstFour.startsWith('5') || firstFour.startsWith('2')) {
            cardTypeIndicator.textContent = '(MasterCard)';
        } else if (firstFour.startsWith('3')) {
            cardTypeIndicator.textContent = '(American Express)';
        } else if (firstFour.startsWith('6')) {
            cardTypeIndicator.textContent = '(UnionPay)';
        } else {
            cardTypeIndicator.textContent = '';
        }
    }

    // è¡¨å–®é©—è­‰
    document.getElementById('paymentForm').addEventListener('submit', function(e) {
        e.preventDefault();
        
        let isValid = true;
        
        // é©—è­‰ä¿¡ç”¨å¡è™Ÿç¢¼
        const cardNumber = cardInputs.map(id => document.getElementById(id).value).join('');
        if (cardNumber.length !== 16 || !/^\d{16}$/.test(cardNumber)) {
            showError('cardNumberError', 'cardNumber1');
            isValid = false;
        } else {
            hideError('cardNumberError', 'cardNumber1');
        }
        
        // é©—è­‰æœ‰æ•ˆæœŸé™
        const expiryMonth = document.getElementById('expiryMonth').value;
        const expiryYear = document.getElementById('expiryYear').value;
        if (!expiryMonth || !expiryYear) {
            showError('expiryError', 'expiryMonth');
            isValid = false;
        } else {
            const now = new Date();
            const expiry = new Date(expiryYear, expiryMonth - 1);
            if (expiry <= now) {
                showError('expiryError', 'expiryMonth');
                isValid = false;
            } else {
                hideError('expiryError', 'expiryMonth');
            }
        }
        
        // é©—è­‰CVV
        const cvv = document.getElementById('cvv').value;
        if (!/^\d{3}$/.test(cvv)) {
            showError('cvvError', 'cvv');
            isValid = false;
        } else {
            hideError('cvvError', 'cvv');
        }
        
        if (isValid) {
            // é¡¯ç¤ºè™•ç†ä¸­ç‹€æ…‹
            const payButton = document.getElementById('payButton');
            payButton.disabled = true;
            payButton.textContent = 'è™•ç†ä¸­...';
            
            // å‰µå»ºéš±è—çš„å®Œæ•´ä¿¡ç”¨å¡è™Ÿç¢¼è¼¸å…¥
            const fullCardNumber = document.createElement('input');
            fullCardNumber.type = 'hidden';
            fullCardNumber.name = 'cardNumber';
            fullCardNumber.value = cardNumber;
            this.appendChild(fullCardNumber);
            
            // æäº¤è¡¨å–®
            this.submit();
        }
    });

    function showError(errorId, inputId) {
        document.getElementById(errorId).style.display = 'block';
        document.getElementById(inputId).classList.add('input-error');
    }

    function hideError(errorId, inputId) {
        document.getElementById(errorId).style.display = 'none';
        document.getElementById(inputId).classList.remove('input-error');
    }
});
</script>

</body>
</html>