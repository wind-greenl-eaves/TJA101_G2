<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é©—è­‰ç¢¼æ¸¬è©¦å·¥å…·</title>
    <style>
        body {
            font-family: 'Microsoft JhengHei', Arial, sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .test-section h3 {
            margin-top: 0;
            color: #333;
        }
        .button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        .button:hover {
            background: #0056b3;
        }
        .success {
            background: #28a745;
        }
        .danger {
            background: #dc3545;
        }
        .result {
            margin: 10px 0;
            padding: 10px;
            border-radius: 4px;
            background: #f8f9fa;
            border: 1px solid #dee2e6;
        }
        .input-group {
            margin: 10px 0;
        }
        .input-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        .input-group input {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
        }
        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .status.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ§ª é©—è­‰ç¢¼æ¸¬è©¦å·¥å…·</h1>
        <p>é€™å€‹å·¥å…·å¯ä»¥å¹«åŠ©æ‚¨æ¸¬è©¦å’Œè¨ºæ–·é©—è­‰ç¢¼åŠŸèƒ½çš„å•é¡Œã€‚</p>
        
        <!-- Redis é€£æ¥æ¸¬è©¦ -->
        <div class="test-section">
            <h3>1. Redis é€£æ¥æ¸¬è©¦</h3>
            <p>æ¸¬è©¦ Redis æœå‹™æ˜¯å¦æ­£å¸¸é‹è¡Œ</p>
            <button class="button" onclick="testRedisConnection()">æ¸¬è©¦ Redis é€£æ¥</button>
            <div id="redisResult" class="result" style="display: none;"></div>
        </div>
        
        <!-- æŸ¥çœ‹ Redis Keys -->
        <div class="test-section">
            <h3>2. æŸ¥çœ‹ Redis æ•¸æ“š</h3>
            <p>æŸ¥çœ‹ Redis ä¸­ç¾æœ‰çš„é©—è­‰ç¢¼æ•¸æ“š</p>
            <button class="button" onclick="viewRedisKeys()">æŸ¥çœ‹ Redis Keys</button>
            <div id="keysResult" class="result" style="display: none;"></div>
        </div>
        
        <!-- é©—è­‰ç¢¼åŠŸèƒ½æ¸¬è©¦ -->
        <div class="test-section">
            <h3>3. é©—è­‰ç¢¼åŠŸèƒ½æ¸¬è©¦</h3>
            <div class="input-group">
                <label for="testEmail">æ¸¬è©¦ç”¨é›»å­éƒµä»¶ï¼š</label>
                <input type="email" id="testEmail" value="test@example.com" placeholder="è¼¸å…¥è¦æ¸¬è©¦çš„é›»å­éƒµä»¶">
            </div>
            <button class="button" onclick="testVerificationCode()">æ¸¬è©¦é©—è­‰ç¢¼ç”Ÿæˆå’Œé©—è­‰</button>
            <div id="verificationResult" class="result" style="display: none;"></div>
        </div>
        
        <!-- æ‰‹å‹•è¨­ç½®é©—è­‰ç¢¼ -->
        <div class="test-section">
            <h3>4. æ‰‹å‹•è¨­ç½®é©—è­‰ç¢¼</h3>
            <p>ç‚ºç‰¹å®šéƒµç®±æ‰‹å‹•è¨­ç½®é©—è­‰ç¢¼ï¼ˆç”¨æ–¼æ¸¬è©¦é©—è­‰æµç¨‹ï¼‰</p>
            <div class="input-group">
                <label for="manualEmail">é›»å­éƒµä»¶ï¼š</label>
                <input type="email" id="manualEmail" value="trial607@trial.co" placeholder="è¼¸å…¥é›»å­éƒµä»¶">
            </div>
            <div class="input-group">
                <label for="manualCode">é©—è­‰ç¢¼ï¼ˆ6ä½æ•¸å­—ï¼‰ï¼š</label>
                <input type="text" id="manualCode" value="123456" placeholder="è¼¸å…¥6ä½æ•¸é©—è­‰ç¢¼" maxlength="6">
            </div>
            <button class="button success" onclick="setManualCode()">è¨­ç½®é©—è­‰ç¢¼</button>
            <div id="manualResult" class="result" style="display: none;"></div>
        </div>
        
        <!-- å®Œæ•´è¨»å†Šæµç¨‹æ¸¬è©¦ -->
        <div class="test-section">
            <h3>5. å®Œæ•´è¨»å†Šæµç¨‹æ¸¬è©¦</h3>
            <p>æ¸¬è©¦å¾è¨»å†Šåˆ°é©—è­‰çš„å®Œæ•´æµç¨‹</p>
            <div class="status info">
                <strong>æ¸¬è©¦æ­¥é©Ÿï¼š</strong><br>
                1. é»æ“Šä¸‹æ–¹æŒ‰éˆ•å‰å¾€è¨»å†Šé é¢<br>
                2. ä½¿ç”¨ã€Œä¸æƒ³å¡«è³‡æ–™å°±æŒ‰é€™è£¡å§!ã€æŒ‰éˆ•å¿«é€Ÿå¡«å…¥æ¸¬è©¦è³‡æ–™<br>
                3. æäº¤è¨»å†Š<br>
                4. æŸ¥æ”¶éƒµä»¶ (young19960127@gmail.com)<br>
                5. åœ¨é©—è­‰é é¢è¼¸å…¥æ”¶åˆ°çš„é©—è­‰ç¢¼
            </div>
            <button class="button success" onclick="goToRegister()">å‰å¾€è¨»å†Šé é¢æ¸¬è©¦</button>
            <button class="button" onclick="goToVerify()">å‰å¾€é©—è­‰é é¢</button>
        </div>
        
        <!-- ç³»çµ±ç‹€æ…‹ -->
        <div class="test-section">
            <h3>6. ç³»çµ±ç‹€æ…‹æª¢æŸ¥</h3>
            <div id="systemStatus" class="status info">
                <strong>ç•¶å‰é…ç½®ï¼š</strong><br>
                é©—è­‰ç¢¼å­˜å„²æ–¹å¼: <span id="storageType">æª¢æŸ¥ä¸­...</span><br>
                ç³»çµ±æ™‚é–“: <span id="systemTime"></span>
            </div>
            <button class="button" onclick="checkSystemStatus()">åˆ·æ–°ç³»çµ±ç‹€æ…‹</button>
        </div>
    </div>

    <script>
        // é é¢è¼‰å…¥æ™‚æª¢æŸ¥ç³»çµ±ç‹€æ…‹
        document.addEventListener('DOMContentLoaded', function() {
            checkSystemStatus();
            document.getElementById('systemTime').textContent = new Date().toLocaleString('zh-TW');
        });

        // æ¸¬è©¦ Redis é€£æ¥
        async function testRedisConnection() {
            const resultDiv = document.getElementById('redisResult');
            resultDiv.style.display = 'block';
            resultDiv.innerHTML = '<strong>æ¸¬è©¦ä¸­...</strong>';
            
            try {
                const response = await fetch('/test/redis-connection');
                const data = await response.json();
                
                if (data.connection === 'æˆåŠŸ') {
                    resultDiv.className = 'result status success';
                    resultDiv.innerHTML = `
                        <strong>âœ… Redis é€£æ¥æˆåŠŸ</strong><br>
                        å¯«å…¥æ¸¬è©¦: ${data.testWrite}<br>
                        è®€å–æ¸¬è©¦: ${data.testRead}<br>
                        æ¸¬è©¦å€¼: ${data.testValue}
                    `;
                } else {
                    resultDiv.className = 'result status error';
                    resultDiv.innerHTML = `
                        <strong>âŒ Redis é€£æ¥å¤±æ•—</strong><br>
                        éŒ¯èª¤: ${data.error}
                    `;
                }
            } catch (error) {
                resultDiv.className = 'result status error';
                resultDiv.innerHTML = `<strong>âŒ è«‹æ±‚å¤±æ•—:</strong> ${error.message}`;
            }
        }

        // æŸ¥çœ‹ Redis Keys
        async function viewRedisKeys() {
            const resultDiv = document.getElementById('keysResult');
            resultDiv.style.display = 'block';
            resultDiv.innerHTML = '<strong>æŸ¥è©¢ä¸­...</strong>';
            
            try {
                const response = await fetch('/test/redis-keys');
                const data = await response.json();
                
                resultDiv.className = 'result status info';
                resultDiv.innerHTML = `
                    <strong>ğŸ“Š Redis æ•¸æ“šç‹€æ…‹</strong><br>
                    ç¸½ Keys æ•¸é‡: ${data.totalKeys}<br>
                    é©—è­‰ç¢¼ Keys: ${data.verificationKeys ? data.verificationKeys.length : 0}<br>
                    <br><strong>æ‰€æœ‰ Keys:</strong><br>
                    ${data.allKeys && data.allKeys.length > 0 ? data.allKeys.join('<br>') : 'ç„¡æ•¸æ“š'}<br>
                    <br><strong>é©—è­‰ç¢¼ Keys:</strong><br>
                    ${data.verificationKeys && data.verificationKeys.length > 0 ? data.verificationKeys.join('<br>') : 'ç„¡é©—è­‰ç¢¼æ•¸æ“š'}
                `;
            } catch (error) {
                resultDiv.className = 'result status error';
                resultDiv.innerHTML = `<strong>âŒ æŸ¥è©¢å¤±æ•—:</strong> ${error.message}`;
            }
        }

        // æ¸¬è©¦é©—è­‰ç¢¼åŠŸèƒ½
        async function testVerificationCode() {
            const email = document.getElementById('testEmail').value;
            const resultDiv = document.getElementById('verificationResult');
            
            if (!email) {
                alert('è«‹è¼¸å…¥é›»å­éƒµä»¶åœ°å€');
                return;
            }
            
            resultDiv.style.display = 'block';
            resultDiv.innerHTML = '<strong>æ¸¬è©¦ä¸­...</strong>';
            
            try {
                const response = await fetch(`/test/verification-code?email=${encodeURIComponent(email)}`);
                const data = await response.json();
                
                if (data.verifyResult === 'æˆåŠŸ') {
                    resultDiv.className = 'result status success';
                    resultDiv.innerHTML = `
                        <strong>âœ… é©—è­‰ç¢¼åŠŸèƒ½æ¸¬è©¦æˆåŠŸ</strong><br>
                        ç”Ÿæˆé©—è­‰ç¢¼: ${data.generatedCode}<br>
                        å­˜å„²çµæœ: ${data.storeResult}<br>
                        å­˜åœ¨æª¢æŸ¥: ${data.existsCheck}<br>
                        é©—è­‰çµæœ: ${data.verifyResult}
                    `;
                } else {
                    resultDiv.className = 'result status error';
                    resultDiv.innerHTML = `
                        <strong>âŒ é©—è­‰ç¢¼åŠŸèƒ½æ¸¬è©¦å¤±æ•—</strong><br>
                        ç”Ÿæˆé©—è­‰ç¢¼: ${data.generatedCode || 'å¤±æ•—'}<br>
                        å­˜å„²çµæœ: ${data.storeResult || 'å¤±æ•—'}<br>
                        å­˜åœ¨æª¢æŸ¥: ${data.existsCheck || 'å¤±æ•—'}<br>
                        é©—è­‰çµæœ: ${data.verifyResult || 'å¤±æ•—'}<br>
                        éŒ¯èª¤: ${data.error || 'æœªçŸ¥éŒ¯èª¤'}
                    `;
                }
            } catch (error) {
                resultDiv.className = 'result status error';
                resultDiv.innerHTML = `<strong>âŒ æ¸¬è©¦å¤±æ•—:</strong> ${error.message}`;
            }
        }

        // æ‰‹å‹•è¨­ç½®é©—è­‰ç¢¼
        async function setManualCode() {
            const email = document.getElementById('manualEmail').value;
            const code = document.getElementById('manualCode').value;
            const resultDiv = document.getElementById('manualResult');
            
            if (!email || !code) {
                alert('è«‹è¼¸å…¥é›»å­éƒµä»¶å’Œé©—è­‰ç¢¼');
                return;
            }
            
            if (!/^\d{6}$/.test(code)) {
                alert('é©—è­‰ç¢¼å¿…é ˆæ˜¯6ä½æ•¸å­—');
                return;
            }
            
            resultDiv.style.display = 'block';
            resultDiv.innerHTML = '<strong>è¨­ç½®ä¸­...</strong>';
            
            try {
                const response = await fetch('/test/set-verification-code', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: `email=${encodeURIComponent(email)}&code=${encodeURIComponent(code)}`
                });
                const data = await response.json();
                
                if (data.result === 'è¨­ç½®æˆåŠŸ') {
                    resultDiv.className = 'result status success';
                    resultDiv.innerHTML = `
                        <strong>âœ… é©—è­‰ç¢¼è¨­ç½®æˆåŠŸ</strong><br>
                        éƒµç®±: ${data.email}<br>
                        é©—è­‰ç¢¼: ${data.code}<br>
                        é©—è­‰å­˜åœ¨: ${data.verifyExists}<br>
                        <br><strong>ğŸ’¡ æç¤º:</strong> ç¾åœ¨æ‚¨å¯ä»¥ä½¿ç”¨é€™å€‹é©—è­‰ç¢¼åœ¨é©—è­‰é é¢é€²è¡Œæ¸¬è©¦
                    `;
                } else {
                    resultDiv.className = 'result status error';
                    resultDiv.innerHTML = `
                        <strong>âŒ è¨­ç½®å¤±æ•—</strong><br>
                        éŒ¯èª¤: ${data.error}
                    `;
                }
            } catch (error) {
                resultDiv.className = 'result status error';
                resultDiv.innerHTML = `<strong>âŒ è¨­ç½®å¤±æ•—:</strong> ${error.message}`;
            }
        }

        // å‰å¾€è¨»å†Šé é¢
        function goToRegister() {
            window.open('/member/register', '_blank');
        }

        // å‰å¾€é©—è­‰é é¢
        function goToVerify() {
            window.open('/member/verify', '_blank');
        }

        // æª¢æŸ¥ç³»çµ±ç‹€æ…‹
        async function checkSystemStatus() {
            try {
                // æª¢æŸ¥ Redis é€£æ¥ä¾†åˆ¤æ–·å­˜å„²é¡å‹
                const response = await fetch('/test/redis-connection');
                const data = await response.json();
                
                const storageTypeElement = document.getElementById('storageType');
                if (data.connection === 'æˆåŠŸ') {
                    storageTypeElement.textContent = 'Redis (æ­£å¸¸)';
                    storageTypeElement.style.color = '#28a745';
                } else {
                    storageTypeElement.textContent = 'å…§å­˜å­˜å„² (Redis ä¸å¯ç”¨)';
                    storageTypeElement.style.color = '#ffc107';
                }
                
                document.getElementById('systemTime').textContent = new Date().toLocaleString('zh-TW');
            } catch (error) {
                document.getElementById('storageType').textContent = 'æª¢æŸ¥å¤±æ•—';
                document.getElementById('storageType').style.color = '#dc3545';
            }
        }
    </script>
</body>
</html>